<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'DETAILS.TITLE' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding custom-content">
  <form [formGroup]="form">
    <!-- Profile Image Section -->
    <div class="profile-image-section">
      <div class="image-container" (click)="presentImageSourceActionSheet()">
        <ng-container *ngIf="!isUploading; else uploadingTemplate">
          <img [src]="imageDisplayUrl" *ngIf="imageDisplayUrl" alt="Profile photo">
          <div class="placeholder" *ngIf="!imageDisplayUrl">
            <ion-icon name="person"></ion-icon>
          </div>
          <div class="overlay">
            <ion-icon name="camera"></ion-icon>
          </div>
        </ng-container>
        <ng-template #uploadingTemplate>
          <div class="upload-loader">
            <ion-spinner name="circular"></ion-spinner>
            <p>{{ 'DETAILS.UPLOAD_STATUS.UPLOADING' | translate }}</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Rest of the form with updated styling -->
    <div class="form-container">
      <ion-list>
        <!-- Personal Information -->
        <ion-item-group class="custom-group">
          <ion-item-divider>
            <ion-label>{{ 'DETAILS.PERSONAL_INFO.TITLE' | translate }}</ion-label>
          </ion-item-divider>

          <ion-item [class.ion-invalid]="form.get('fullname')?.touched && form.get('fullname')?.invalid">
            <ion-label position="floating">{{ 'DETAILS.PERSONAL_INFO.FIRST_NAME' | translate }}</ion-label>
            <ion-input formControlName="fullname" type="text">
            </ion-input>
            <ion-note slot="error" *ngIf="form.get('fullname')?.touched && form.get('fullname')?.errors?.['required']">
              {{ 'VALIDATION.REQUIRED' | translate }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-input formControlName="lastname" [placeholder]="'DETAILS.PERSONAL_INFO.LAST_NAME' | translate">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input formControlName="email" type="email" [placeholder]="'DETAILS.PERSONAL_INFO.EMAIL' | translate">
            </ion-input>
          </ion-item>
        </ion-item-group>

        <!-- Vehicle Information -->
        <ion-item-group class="custom-group">
          <ion-item-divider>
            <ion-label>{{ 'DETAILS.VEHICLE_INFO.TITLE' | translate }}</ion-label>
          </ion-item-divider>
          <ion-item>
            <ion-input formControlName="plateNumber" [placeholder]="'DETAILS.VEHICLE_INFO.PLATE_NUMBER' | translate">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-select formControlName="carType" [placeholder]="'DETAILS.VEHICLE_INFO.CAR_TYPE' | translate">
              <ion-select-option *ngFor="let type of cartypes" [value]="type.id">
                {{type.name}}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-input formControlName="carName" [placeholder]="'DETAILS.VEHICLE_INFO.CAR_NAME' | translate">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input formControlName="mileage" type="number"
              [placeholder]="'DETAILS.VEHICLE_INFO.MILEAGE' | translate">
            </ion-input>
          </ion-item>
        </ion-item-group>

        <!-- License Information -->
        <ion-item-group class="custom-group">
          <ion-item-divider>
            <ion-label>{{ 'DETAILS.LICENSE_INFO.TITLE' | translate }}</ion-label>
          </ion-item-divider>

          <ion-item>
            <ion-input formControlName="driverLicense" [placeholder]="'DETAILS.LICENSE_INFO.NUMBER' | translate">
            </ion-input>
          </ion-item>

          <!-- License Image Preview -->
          <div class="license-image-section">
            <div class="license-image-container" (click)="selectDriverLicenseImage()">
              <ng-container *ngIf="!isUploadingLicense; else licenseUploadingTemplate">
                <img [src]="licenseDisplayUrl" *ngIf="licenseDisplayUrl" alt="License photo">
                <div class="placeholder" *ngIf="!licenseDisplayUrl">
                  <ion-icon name="id-card"></ion-icon>
                  <p>{{ 'DETAILS.LICENSE_INFO.TAP_TO_UPLOAD' | translate }}</p>
                </div>
                <div class="overlay" *ngIf="licenseDisplayUrl">
                  <ion-icon name="camera"></ion-icon>
                </div>
              </ng-container>
              <ng-template #licenseUploadingTemplate>
                <div class="upload-loader">
                  <ion-spinner name="circular"></ion-spinner>
                  <p>{{ 'DETAILS.UPLOAD_STATUS.UPLOADING' | translate }}</p>
                </div>
              </ng-template>
            </div>
          </div>
        </ion-item-group>
      </ion-list>
    </div>

    <div class="submit-section">
      <ion-button expand="block" (click)="updateProfile()" [disabled]="!isFormCompleteForSubmission() || isSubmitting"
        class="submit-button">
        <ion-icon name="save" slot="start"></ion-icon>
        {{ 'DETAILS.BUTTONS.SUBMIT' | translate }}
        <ion-spinner name="crescent" *ngIf="isSubmitting"></ion-spinner>
      </ion-button>
      
      <!-- Debug info - remove this in production -->
      <div style="margin-top: 10px; font-size: 12px; color: #666;" *ngIf="!isFormCompleteForSubmission()">
        <p>Missing requirements:</p>
        <p *ngIf="!form.valid">❌ Form validation incomplete</p>
        <p *ngIf="!imageUrl || (!imageUrl.startsWith('img_') && !imageUrl.startsWith('assets/'))">❌ Profile photo required</p>
        <p *ngIf="!form.get('driverLicenseImage')?.value || (!form.get('driverLicenseImage')?.value.startsWith('img_') && !form.get('driverLicenseImage')?.value.startsWith('assets/'))">❌ License photo required</p>
      </div>

      <!-- Connectivity test button - remove in production -->
      <ion-button fill="clear" size="small" (click)="testConnectivity()" style="margin-top: 10px;">
        <ion-icon name="wifi" slot="start"></ion-icon>
        Test Firebase Connection
      </ion-button>
    </div>
  </form>
</ion-content>